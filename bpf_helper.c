#define _GNU_SOURCE

#include <assert.h>
#include <linux/bpf.h>
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/syscall.h>
#include <unistd.h>

#include "bpf_helper.h"

char bpf_log_buff[0x200000];

int bpf(int cmd, union bpf_attr *attr, int attr_size)
{
    return syscall(__NR_bpf, cmd, attr, attr_size);
}

int bpf_map_create(uint32_t value_size, uint32_t max_entries)
{
    union bpf_attr attr = {
        .map_type = BPF_MAP_TYPE_ARRAY,
        .key_size = sizeof(int),
        .value_size = value_size,
        .max_entries = max_entries
    };
    int fd = bpf(BPF_MAP_CREATE, &attr, sizeof(attr));
    assert(fd != -1);
    return fd;
}

void bpf_map_lookup_elem(int fd, const void *key, void *value)
{
    union bpf_attr attr = {
        .map_fd = fd,
        .key = (uint64_t)key,
        .value = (uint64_t)value,
    };
    int ret = bpf(BPF_MAP_LOOKUP_ELEM, &attr, sizeof(attr));
    assert(ret != -1);
}

void bpf_map_update_elem(int fd, const void *key, void *value, uint64_t flags)
{
	union bpf_attr attr = {
        .map_fd = fd,
        .key = (uint64_t)key,
        .value = (uint64_t)value,
        .flags = flags,
    };
    int ret = bpf(BPF_MAP_UPDATE_ELEM, &attr, sizeof(attr));
    assert(ret != -1);
}

int run_bpf_prog(struct bpf_insn *insns, int insn_cnt, char *data, int data_len)
{
    union bpf_attr attr = {
        .prog_type = BPF_PROG_TYPE_SOCKET_FILTER,
        .insn_cnt = insn_cnt,
        .insns = (uint64_t)insns,
        .license = (uint64_t)"GPL",
#ifdef DEBUG
        .log_level = 2,
        .log_size = sizeof(bpf_log_buff),
        .log_buf = (uint64_t)bpf_log_buff,
#else
        .log_level = 0,
        .log_size = 0,
        .log_buf = 0,
#endif
    };

    int bpf_fd = bpf(BPF_PROG_LOAD, &attr, sizeof(attr));

    assert(bpf_fd != -1);
    int socks[2] = {};

    int ret = socketpair(AF_UNIX, SOCK_DGRAM, 0, socks);
    assert(ret != -1);
    ret = setsockopt(socks[0], SOL_SOCKET, SO_ATTACH_BPF, &bpf_fd, sizeof(int));
    assert(ret != -1);

    ret = send(socks[1], data, data_len, 0);
    assert(ret != -1);

    //char result[0x100];
    //int n_read = read(socks[0], a, 0x100);
    //printf("Read %d bytes: %s\n", n_read, result);

#ifdef DEBUG
    printf("%s\n", bpf_log_buff);
#endif
    
    close(socks[0]);
    close(socks[1]);
    close(bpf_fd);
}
